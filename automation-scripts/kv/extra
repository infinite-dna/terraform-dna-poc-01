- name: Check if the certificate already exists in the store
  ansible.windows.win_shell: |
    $store = New-Object System.Security.Cryptography.X509Certificates.X509Store -ArgumentList "My", "LocalMachine"
    $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]::ReadOnly)
    $certExists = $store.Certificates | Where-Object { $_.Thumbprint -eq "{{ cert_data.thumbprint }}" }
    $store.Close()
    if ($certExists) {
      Write-Output "Certificate already exists."
      exit 0
    }
    exit 1
  args:
    executable: powershell
  register: cert_check
  failed_when: cert_check.rc != 0 and cert_check.stdout != "Certificate already exists."
